<!DOCTYPE html>
<html lang="en">
<head>
        <title>DevOps as Contract</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>
<body>

    <div class="navigation pure-menu pure-menu-horizontal">
        <a href="/" class="pure-menu-heading  pure-menu-link">/dev/isra/blog/*</a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"></li>

            <li class="pure-menu-item"><a href="/pages/about-me.html" class="pure-menu-link">About me...</a></li>
            <li class="pure-menu-item"><a href="/pages/consulting.html" class="pure-menu-link">Consulting</a></li>
            <li class="pure-menu-item"><a href="/pages/now.html" class="pure-menu-link">Now</a></li>
            <li class="pure-menu-item"><a href="/pages/talks.html" class="pure-menu-link">Talks</a></li>
            <li class="pure-menu-item pure-menu-selected"><a href="/category/blog.html" class="pure-menu-link">Blog</a></li>
            <li class="pure-menu-item"><a href="/category/espanol.html" class="pure-menu-link">Español</a></li>
        </ul>
    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
<div class="pure-u-3-4 meta-data">
    <a href="/category/blog.html" class="category">Blog</a><br />

    <a class="author" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
    &mdash; <abbr title="2020-08-10T00:00:00+04:00">Mon 10 August 2020</abbr>
</div>        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image" style="background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url(https://dl.dropboxusercontent.com/s/y7hf2p40crdu19y/careem.jpeg);">
                <img src="https://dl.dropboxusercontent.com/s/y7hf2p40crdu19y/careem.jpeg" alt="DevOps as Contract">
                <div class="title">
                <h1>
                    DevOps as Contract
                </h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p>DevOps seems to be a trending topic in the software world for quite a while
now, organzations are adopting DevOps practices progressively and it's been
seen as a valuable skill to have within an Engineer's toolbelt.</p>
<p>There are many definitions of what DevOps means, everyone has their own
definition, I have mine, of course, and that's the one I'll share here.</p>
<h1>What does DevOps mean to me?</h1>
<p>DevOps is a term that mixes Development and Operations, so, it involves
all the Operations aspects of Software Engineering, things like automation,
infrastructure provisioning, deployment, monitoring and so on.</p>
<p>To me, DevOps is not about having a different team managing everyone's operations
component, it's about enabling everyone to take care of their own teams
operations, this means, administrating and managing all the platforms needed
for the software operations: version control systems, CI/CD, monitoring, etc.
This means, DevOps is about culture and ownership, every team should own
not only the software they write an maintain, but also the processes around
thart software, in the end, no one is better suited to manage it than the
team mainaining it, they have all the context, they know how to deploy it,
which metrics are important for it so that they can trigger alerts to let them
know of anything goes wrong in a timely manner, they know how to run it and
debug it so, it makes sense they own it from the ground up.</p>
<p>Now, if we see the landscape of all the DevOps-related tools it would be
something like the following image:</p>
<p><img alt="DevOps tools landscape by James Bowman" src="https://dl.dropboxusercontent.com/s/xvxtntpfsbg8zfn/devops.jpg"></p>
<p>The image looks overwhelming, does owning all my processes means that I have
to learn one tool per domain? if so, what if the company chooses one and then
decides to migrate?, then I'll have to learn a new one from scratch!. I don't
know, that looks painful, right? too much work and I also have a Product
Manager breathing on my neck reminding me we need to release few features
yesterday. </p>
<p>Well, not really, you don't have to learn all that unless you want to, but
at least you don't need to.</p>
<h1>Then... how?</h1>
<p>Software Engineering is a lot about abstractions, we build abstractions
for everything, we don't let others access our resources directly, here are
some examples:</p>
<ul>
<li>
<p>We don't let our client applications call our databases directly and throw
queries at them, we build a backend which abstracts all the business logic
and the underlying resources and expose all of that through an API.</p>
</li>
<li>
<p>We don't give access to our services directly, we encapsulate them in a private
network and expose them via an API Gateway.</p>
</li>
<li>
<p>We don't like duplication, so instead of writing the same over and over again,
we encapsulate relevant code in classes, functions or modules and expose the
functionality as functions or methods.</p>
</li>
</ul>
<p>We do this not only to protect our resources but also to make our clients lives
easier and simpler. If we don't allow direct access to our infrastructure instead
we expose different forms of API so that others (both people and systems) use
them and it works fine, why don't we do the same with our DevOps insfrastructure?</p>
<h1>Contracts</h1>
<p>Strictly speaking, a contract is "a written or spoken agreement between two
or more entities", but the concept of "contracts" is not foreign to Computer
Science, we use contracts for almost everything:</p>
<ul>
<li>
<p>REST APIs are contracts, the users need to follow certain rules in order
for the requests to be accepted and processed successfully and the service
also follows some rules so that the client knows what to expect and what to do
in case of errors.</p>
</li>
<li>
<p>Third party libraries also expose some soft of contracts, one needs to use
the functions they expose in order to access the functionalty</p>
</li>
<li>
<p>The code we write is full of contracts: classes, functions, internal modules
expose functionalty and that's also a contract in some way</p>
</li>
<li>
<p>Even the programming languages we use are contracts, we need to follow certain
written syntactical rules and use a set of keywords so that the programs
are compiles/interpreted without errors.</p>
</li>
</ul>
<h1>A DevOps Contract</h1>
<p>What this means is encapsulating all your DevOps infrastructure behind a contract
which everyone needs to follow in order to get whatever the component does,
whether it is CI/CD, Infrastructure Provisioning or Monitoring, all engineers
shouldn't be forced to learn Jenkins, Cloudformation or Prometheus in order to do
all the setup for the services they build/maintain. What if some day we decide
not to use Cloudformation anymore and migrate to Terraform?, then all engineers
will need to spend a significant amount of time learning a new technology.</p>
<p>This isn't new either, Gitlab offers CICD as a contract. To use Gitlab's
CICD the only things that needs to be done is writing a YAML file, following
certain conventions and that's it.</p>
<h2>CICD as Contract</h2>
<p>This is a short story of how we implemented this at Careem about two years ago,
this was my first big project in the organization, again, this is not a new
concept, but it's often overlooked.</p>
<h3>The Scenario</h3>
<p>More or less 100 services, not all of them with automated deployments, 1 or 2 
deployments to production a month, almost no automated testing. A lot of moving
parts and unknowns since we were migrating (or not) away from Phabricator as
code hosting service.</p>
<p>We did have a DevOps team which maintained a very robust Jenkins cluster with
on-demand agents, but not used by all the teams because "no one had time to
learn groovy or write Jenkinsfiles", so, DevOps team was turned into the
Jenkinsfile team, they effectively wrote and maintain everyones pipelines,
it was a small team so they spent most of their time writing and updating
Jenkinsfiles as per other teams requests, this got them very frustrated because
there are more interesting things to do in DevOps and in Tech in general than
writing Jenkinsfiles.</p>
<h3>The Vision</h3>
<p>We did have a DevOps team as well as a robust Jenkins installation, we only
needed to get them to focus on doing DevOps stuff, but they were stuck with
the Jenkinsfile thing, most of the teams were relying on them.</p>
<p>The overall vision was to have the DevOps team maintaining the CICD platform,
our Jenkins cluster, and worrying about things like provisioning infrastucture
in an efficient way, cost management, compliance, etc. In summary, DevOps
would be the enabler team so that everyone could maintain and own their code
and the processes around that code.</p>
<p>The DevOps team maintains the platform and the contract to use that platform
and the service teams (the ones using the CICD platform) would only consume
the contract and follow the rules defined by the DevOps team and everyone will
be happy.</p>
<h3>The execution</h3>
<p>We did know what we wanted, we wanted to enable all the teams to own their
services in full, not only the code, but also the operations, for this, we knew
we had to make it easier for them and lower the entry barrier, the hypothesys
we had was that most of the teams did not have automation around their services
because they didn't have time (or want) to iinvest some time in learning about
Jenkins' declaratiive language for pipelines (the one used to write Jenkinsfiles)</p>
<h4>Gathering information</h4>
<p>To start, we ran a poll to validate our hypothesys, the result was successful,
so, now we knew we needed to move away from Jenkinsfiles and use something else
in order to have the teams using whatever tool we roll out.</p>
<p>At that time, since we were moving away from Phabricator, we were trying to push
for Gitlab, but for some financial topics we decided to move to Bitbucket, we
were already using Confluence and Jira so it made sense.</p>
<h4>Decisions</h4>
<p>We knew we had to move away from Jenkinsfiles, but we didn't want to move away
from Jenkins, the team invested a lot of time and effort in making it stable
and reliable, plus it was a well known technology, migrating to something else
would mean spending some time in R&amp;D and building proof of concepts with other
tools, time we didn't have, so, whatever we wanted to do, it had to be built on
top of Jenkins.</p>
<p>When we were experimenting with generating Jenkinsfiles from configuration files
we found out a team in Berlin had a small Java program which took a YAML file,
generated a Jenkins scripted pipeline and imported it directly in Jenkins, the
best part was that it ran as a Jenkins job. We decided to adopt it and extend
it. YAML is a very well known format, it has a low entry barrier and a lot
of teams were already using it for their config files and other things.</p>
<p>Theres a huge variety of languages and stacks within Careem, but Java is the most
common one along with Springboot framework, we decided to solve for the most
common use case (Java + Springboot) and rely on <a href="">inner sourcing</a>
to accept contributions from other teams and extend support to other languages
and techologies.</p>
<p>We also wanted to control few things in the pipelines by enforcing some mandatory
stages as well as quality gates based on few metrics such as code quality and
test coverage, it had to be gradual, so, we established a baseline and set everything
up to fail if quality went below that, these baseline was agreed on a per-team basis
with each tech lead and engineering manager.</p>
<h4>The Design</h4>
<p>We came up with a layered design with clear boudaries and responsibilities
for each layer, they also need to be implemented in a decoupled way so that
we can change them if we need to. </p>
<ul>
<li>
<p><strong>Contract layer:</strong> this is the actual contract, it's a set of agreed fields
and configuration settings in a YAML file, this will be processed in other layers.</p>
</li>
<li>
<p><strong>Translation layer:</strong> this is the program in charge of translating the YAML
contract into something we can actually execute in this case is a Java program
we called <em>the pipeline generator</em>, it translates YAML into a Groovy template,
which would be a Jenkins scripted pipeline. This also takes care of managing the
directory structure in Jenkins so we also have a standard structure easy to
document and everyone knows where everything is.</p>
</li>
<li>
<p><strong>Orchestration layer:</strong> this is the one which decides what runs and when, basically
runs the template, this layer is our Jenkins cluster as the generated templates are 
Jenkins scripted piipelines.</p>
</li>
<li>
<p><strong>Excecution layer:</strong> this is the one containing what actually runs on each 
pipeline stage. It's a set of Python scripts using <code>boto3</code> to check the status
of different AWS resources, build and test the code among other common use cases.
This layer is also customizable, so each team can add their own scripts and invoke
them in their pipelines. This layer can also be set up to run inside a Docker
container running a given image or building it from scratch from a Dockerfile, this
removes the problem of missing dependencies in the agents or the need to have different
agent types depending on the team.</p>
</li>
<li>
<p><strong>Infrastructure layer:</strong> this is a set of configurable Terraform modules 
for the most common resources, if needed each team can add their own modules
if they use an AWS resource which is not supported by the core IaC modules.</p>
</li>
</ul>
<p><img alt="Layers design" src="https://dl.dropboxusercontent.com/s/p0idr5040eddpbu/layers_diagram.png">
https://www.dropbox.com?dl=0</p>
<p>Some reasoning about this: </p>
<ul>
<li>
<p>We chose YAML because everyone was already using it
for their configutation files.</p>
</li>
<li>
<p><em>the pipeline generator</em> was a codebase we
adopted from another team so, it was done in Java already. </p>
</li>
<li>
<p>We decided to keep our Jenkins cluster because it was battle tested. </p>
</li>
<li>
<p>We decided to go with Terraform instead of Cloudformation, even though we run 
on AWS, because we can use Terraform to provision resources in other cloud 
providers using the same declarative language, we would only need to learn how
to use the Terraform Provider for the specific cloud service we need to provission
resources on.</p>
</li>
</ul>
<h4>The Execution</h4>
<p>We knew we would have to train everyone to use this CICD solution, so the first
step we took was to document the basic process we inherited from the other team.
We created a page in the internal wiki explaining how to add new pipelines and
set them up to run automatically after we create a pull request in BitBucket and
after we update it or merge it into <code>master</code>. We added <em>the pipeline generator</em>
as a Jenkins job and started approaching teams for the proof of concept.</p>
<p>ADD COMPONENTS DIAGRAM HERE</p>
<p>In the meantime we were adding functionality in order to be able to add enforced
stages, these are stages that were required in order to guarantee good
code quality, we integrated <code>SonarQube</code> into the pipelines and added two enforced
stages:</p>
<ul>
<li>
<p><strong>code-quality:</strong> checks that <code>SonarQube</code>'s analysis is green, meaning there are
no new code smells and the quality values are not less than the previous run.</p>
</li>
<li>
<p><strong>code-coverage:</strong> we decided not to enforce any percentage, we wanted a minimum
coverage of 80%, but enforcing it so early in the process would had been inconvenient
for a lot of teams with not even 10% and would make the teams to take shortcuts
to reach it. Instead we enforced a similar policy: code coverage should not decrease,
this will make the teams write enough tests to keep the current coverage and eventually
increasing it build after build.</p>
</li>
</ul>
<p>ADD A PIPELINE EXAMPLE HERE</p>
<p>By running a controlled PoC with only a handful of teams onboarded into the
solution, we were able to get feedback from real use cases, feature requests
and catch bugs and solve them without affecting the whole tech organization.</p>
<p>After we reached a stable status, meaning, bugs under control and teams happy 
using our solution, we started preparing for a larger scale, we updated the documentation
with the enforced stages and how to add them for unsuported stacks, by default
we implemented them for Java, but the code base is very diverse depending on the team,
some teams use Ruby, some others Python, some are in Node or even Go, those were
unsupported by default, so teams needed to create their own scripts for the
enforced stages.</p>
<p>We dedicated two team members (out of 8) to prepare on-boarding sessions, these
were remote or on-site classroom  sessions where the teams had to send one or 
two members to learn and actually hands on onboard one of their services into
the solution. This way we not only trained people, but also made sure they left
with part of the job done already and being able to repeat it for other services
in their teams. Of course, we found real life scenarios issues and we solved them
with them in front of other engineers so that if they encounter a similar issue
they solve it themselves, as for the bugs, the team members who were giving the
sessions created Jira tickets right away so that the team solved them before the 
session. Also, the members giving the sessions updates the wiki, documenting
the most common issues the teams encountered during the sessions.</p>
<h4>The Result</h4>
<p>After several iterations, about 40 sessions, over 20 wiki pages and I don't know
how many merged pull requests we built a solution which was composed by several
software pieces and it's able to support the generation of:</p>
<ul>
<li>CI pipelines</li>
<li>CD pipelines</li>
<li>Free-style jobs</li>
</ul>
<p>While also allowing the DevOps team to govern the pipelines by adding or 
removing enforced stages as needed. By the end of the process, we achieved almost
90% of adoption and we were doing 39 automated deployments to production every day, taking
into account we started with 1 or 2 every once in a while and some of them
not using any automation it was a significant improvement.</p>
<p>People write this:</p>
<p>ADD YAML HERE</p>
<p>And get this</p>
<p>ADD PIPELINE</p>
<p>With automatic triggers in relevant version control events in GitHub or
BitBucket.</p>
<p>We separated the pipelines list, which is a YAML file where the pipeline generator
finds all the pipelines declared with the team, the service name, the repo to clone
and the location of the corresponding YAML file within the repo, into a separate
component with its own automation to validate the syntax and the contract and
approve the pull request without human intervention to prevent DevOps from being a
bottleneck in approving new pipelines. This used the same contract and tools described
throughout this article.</p>
<p>No one had to learn how to write Terraform if the didn't need to, by just learning
how to write a <code>.tfvars</code> file, they could get away with what was in the core Terraform
modules written by the team. No one had to learn Groovy in order to write their
scripted pipeline, no one had to learn Python either, in the end, the pipeline
executes a command in every stage, so, anything callable from command line would
do as an Execution layer component, if a team needed to add a custom script
for their pipelines or a free style job, they would just write it in Bash or any
language they wanted and provide a docker image or a dockerfile to run it inside
a container which supports what they need. The teams only care about their YAML
files and their config files for other custom behaviors and now, DevOps takes care
of the platform and has time to invest in some other more interesting topics.</p>
<h2>Recommended readings:</h2>
<ul>
<li><a href="https://medium.com/omio-engineering/devops-as-contract-54ebe61de92a">GoEuro's article on DevOps as Contract</a></li>
</ul>
    </div>

    <footer>
        <div class="tags">
            <a href="/tag/devops.html">devops</a>
            <a href="/tag/projects.html">projects</a>
        </div>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u">
                        <a href="/author/israel-fermin-montilla.html"><img src="https://dl.dropboxusercontent.com/s/1bvnowsfke4rs2k/isra.jpg" alt=""></a>
                    </div>
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a></h3>
                        <p class="author-description">
                          {' Full time husband and dad who loves technology and programming. Software Engineer @ Careem / Online Mentor @ codeinstitute.net'}
                        </p>
                    </div>
                    <style>.bmc-button img{height: 34px !important;width: 35px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{padding: 7px 10px 7px 10px !important;line-height: 35px !important;height:51px !important;min-width:217px !important;text-decoration: none !important;display:inline-flex !important;color:#FFFFFF !important;background-color:#FF813F !important;border-radius: 5px !important;border: 1px solid transparent !important;padding: 7px 10px 7px 10px !important;font-size: 28px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#FFFFFF !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/iferminm"><img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee"><span style="margin-left:15px;font-size:28px !important;">Buy me a coffee</span></a>
                </div>
            </div>



        </div>


        <!-- Begin MailChimp Signup Form -->
        <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
        <style type="text/css">
            #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
            /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
            We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style>
        <div id="mc_embed_signup">
            <form action="//iffm.us15.list-manage.com/subscribe/post?u=f9aa59a7fe24a1d24a95b2e41&amp;id=28de70c22b" method="post"
                id="mc-embedded-subscribe-form"
                name="mc-embedded-subscribe-form"
                class="validate" target="_blank"
                novalidate>
                <div id="mc_embed_signup_scroll">
                    <h2>Get notified</h2>
                    <p class="author-description">
                        Get an email whenever I post something or release something cool, I'm always working on something, don't miss it out!
                    </p>
                    <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
                    <div class="mc-field-group">
                        <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
                        </label>
                        <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
                    </div>
                    <div class="mc-field-group">
                        <label for="mce-FNAME">First Name </label>
                        <input type="text" value="" name="FNAME" class="" id="mce-FNAME">
                    </div>
                    <div class="mc-field-group">
                        <label for="mce-LNAME">Last Name </label>
                        <input type="text" value="" name="LNAME" class="" id="mce-LNAME">
                    </div>
                    <div id="mce-responses" class="clear">
                        <div class="response" id="mce-error-response" style="display:none"></div>
                        <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk
                    form bot signups-->
                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text"
                    name="b_f9aa59a7fe24a1d24a95b2e41_28de70c22b"
                    tabindex="-1"
                    value=""></div>
                    <div class="clear"><input type="submit" value="Subscribe" name="subscribe"
                    id="mc-embedded-subscribe"
                    class="button"></div>
                </div>
            </form>
        </div>
        <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($)
        {window.fnames = new Array(); window.ftypes = new
        Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj =
        jQuery.noConflict(true);</script>
        <!--End mc_embed_signup-->






    </footer>


</div>



    <footer class="index-footer">

        <a href="/" title="/dev/isra/blog/*">/dev/isra/blog/*</a>
        <a href="/category/blog.html">Blog</a>
        <a href="/category/espanol.html">Español</a>
        <a href="http://getpelican.com/">Pelican</a>
        <a href="http://python.org/">Python.org</a>
        <a href="http://jinja.pocoo.org/">Jinja2</a>

    </footer>

</body>
</html>